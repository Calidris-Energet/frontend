name: Deploy Frontend Prod

on:
  push:
    branches:
      - main

env:
  TELEGRAM_GROUP_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  install-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Commit
        uses: actions/checkout@master

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
        uses: actions/setup-node@master
        with:
          node-version: 24

      - name: Cache npm dependencies
        uses: actions/cache@master
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Dependencies
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: |
          npm ci

      - name: Get Current Job Log URL
        uses: Tiryoh/gha-jobid-action@main
        if: failure()
        id: jobs
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          job_name: ${{ github.job }}

      - name: Send Telegram Error Message
        if: failure()
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â— ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ â—
            
            ğŸ”¹ Repo: ${{ github.repository }}
            ğŸ”¹ Workflow: ${{ github.workflow }}
            ğŸ”¹ Job: ${{ github.job }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ´Ğ¶Ğ¾Ğ±Ñƒ ğŸ”—
            ${{ steps.jobs.outputs.html_url }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  lint:
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - name: Checkout Commit
        uses: actions/checkout@master

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
        uses: actions/setup-node@master
        with:
          node-version: 24

      - name: Restore npm dependencies
        uses: actions/cache@master
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: ĞŸÑ€Ğ¾Ğ³Ğ¾Ğ½ Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°
        run: npm run lint

      - name: Get Current Job Log URL
        uses: Tiryoh/gha-jobid-action@main
        if: failure()
        id: jobs
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          job_name: ${{ github.job }}

      - name: Send Telegram Error Message
        if: failure()
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â— ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ½Ğ° Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ğ° â—
            
            ğŸ”¹ Repo: ${{ github.repository }}
            ğŸ”¹ Workflow: ${{ github.workflow }}
            ğŸ”¹ Job: ${{ github.job }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ´Ğ¶Ğ¾Ğ±Ñƒ ğŸ”—
            ${{ steps.jobs.outputs.html_url }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  unit-tests:
    runs-on: ubuntu-latest
    needs: install-cache

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Commit
        uses: actions/checkout@master

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
        uses: actions/setup-node@master
        with:
          node-version: 24

      - name: Restore npm dependencies
        uses: actions/cache@master
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: ĞŸÑ€Ğ¾Ğ³Ğ¾Ğ½ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
        run: npx vitest --coverage.enabled true

      - name: 'Report Coverage'
        if: always()
        uses:  davelosert/vitest-coverage-report-action@v2

      - name: Get Current Job Log URL
        uses: Tiryoh/gha-jobid-action@main
        if: failure()
        id: jobs
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          job_name: ${{ github.job }}

      - name: Send Telegram Error Message
        if: failure()
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â— ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ½Ğ° ÑĞ½Ğ¸Ñ‚ Ñ‚ĞµÑÑ‚Ğ¾Ğ² â—
            
            ğŸ”¹ Repo: ${{ github.repository }}
            ğŸ”¹ Workflow: ${{ github.workflow }}
            ğŸ”¹ Job: ${{ github.job }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ´Ğ¶Ğ¾Ğ±Ñƒ ğŸ”—
            ${{ steps.jobs.outputs.html_url }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  integration-tests-run:
    runs-on: ubuntu-latest
    needs: install-cache
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout Commit
        uses: actions/checkout@master

      - name: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Node.js
        uses: actions/setup-node@master
        with:
          node-version: 24

      - name: Restore npm dependencies
        uses: actions/cache@master
        id: cache-dependencies
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Start dev server
        run: npm run dev

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run Cypress with JSON reporter
        id: run-cypress
        run: |
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Cypress Ñ JSON Ñ€ĞµĞ¿Ğ¾Ñ€Ñ‚ĞµÑ€Ğ¾Ğ¼
          npx cypress run --reporter json --reporter-options '{"output":"cypress-report.json"}'
        continue-on-error: true  # Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ñ‚ĞµÑÑ‚Ñ‹ ÑƒĞ¿Ğ°Ğ»Ğ¸

      - name: Parse test results
        id: parse-test-results
        if: always()
        run: |
          if [ -f "cypress-report.json" ]; then
          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSON Ğ¾Ñ‚Ñ‡ĞµÑ‚ Cypress
          TOTAL_TESTS=$(jq '.totalTests' cypress-report.json)
          PASSED_TESTS=$(jq '.totalPassed' cypress-report.json)
          FAILED_TESTS=$(jq '.totalFailed' cypress-report.json)
          
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "test_stats=$PASSED_TESTS/$TOTAL_TESTS" >> $GITHUB_OUTPUT
          else
          echo "total=0" >> $GITHUB_OUTPUT
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
          echo "test_stats=0/0" >> $GITHUB_OUTPUT
          fi

      - name: Generate Report
        if: always()
        run: npm run allure:generate

      - name: Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@master
        with:
          name: allure-results
          path: |
            allure-results/
            allure-report/
            cypress-report.json
          retention-days: 7

  deploy-allure-report:
    runs-on: ubuntu-latest
    needs: integration-tests-run
    if: always()
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Download Allure results artifact
        uses: actions/download-artifact@master
        with:
          name: allure-results
          path: ./

      - name: Get Allure history
        uses: actions/checkout@master
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate and publish Allure report
        uses: simple-elf/allure-report-action@master
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-history

      - name: Get Allure Report URL
        id: allure-url
        run: |
          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ URL Ğ´Ğ»Ñ Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ¼ (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ ÑÑ‚Ğ¾ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ½Ğ°)
          REPORT_DIR="${{ github.run_number }}"
          
          echo "report_url=https://${{ secrets.ALLURE_URL }}/$REPORT_DIR/" >> $GITHUB_OUTPUT

      - name: Send Telegram Report Status
        if: needs.integration-tests-run.result == 'success'
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            âœ…ï¸ Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ âœ…ï¸
            
            ğŸ”¹ Repo: ${{ github.repository }}
            ğŸ”¹ Workflow: ${{ github.workflow }}
            ğŸ”¹ Job: ${{ github.job }}
            
            ğŸ“Š Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚
            ${{ steps.allure-url.outputs.report_url }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Telegram Report Status
        if: needs.integration-tests-run.result == 'failure'
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            â— ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ½Ğ° Ñ‚ĞµÑÑ‚Ğ¾Ğ² â—
            
            ğŸ”¹ Repo: ${{ github.repository }}
            ğŸ”¹ Workflow: ${{ github.workflow }}
            ğŸ”¹ Job: ${{ github.job }}
            ğŸ”¹ Ğ¢ĞµÑÑ‚Ñ‹: ${{ needs.integration-tests-run.result }}
            
            ğŸ“Š Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚
            ${{ steps.allure-url.outputs.report_url }}
            
            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ ğŸ”—
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  build:
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, deploy-allure-report]

    steps:
      - name: Pull code
        uses: appleboy/ssh-action@master
        with:
          port: ${{ secrets.SERVER_PORT }}
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: | 
            cd /home/energet/frontend/
            git fetch
            git checkout ${{ github.ref_name }}
            git pull

      - name: Build frontend
        uses: appleboy/ssh-action@master
        with:
          timeout: 10m
          port: ${{ secrets.SERVER_PORT }}
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /home/energet/frontend/
            docker compose -f docker-compose.prod.yml down -v
            docker compose -f docker-compose.prod.yml up --build -d

  notify-success:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Send Telegram Success Message
        uses: PacificPromise/macos-telegram-action@main
        with:
          type: topic
          message: |
            ğŸ”” Frontend
            âœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ½Ñ‹

            ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ´ ğŸ”—
            ${{ secrets.PRODUCTION_URL || 'ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚' }}
