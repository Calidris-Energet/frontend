---
- hosts: all
  vars:
    frontend_dir: /var/www/frontend
    nvm_dir: "/home/{{ ansible_user }}/.nvm"
    telegram_bot_token: "{{ telegram_bot_token }}"
    telegram_chat_id: "{{ telegram_chat_id }}"

  tasks:
    - name: Ensure front folder exists
      file:
        path: "{{ frontend_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      become: yes

    - name: Pull latest code and switch to main branch
      git:
        repo: "https://github.com/Calidris-Energet/frontend.git"
        dest: "{{ frontend_dir }}"
        update: yes
        version: main
        force: yes
      become: yes

    - name: Install npm dependencies
      community.general.yarn:
        path: "{{ frontend_dir }}"
        state: present

    - name: Run the build script
      ansible.builtin.command:
        cmd: yarn build
        chdir: "{{ frontend_dir }}"

    - name: Send notification to a specific Telegram topic
      community.general.telegram:
        token: "{{ telegram_bot_token }}"
        api_method: 'sendMessage'
        api_args:
          chat_id: "{{ telegram_chat_id }}"
          message_thread_id: "{{ telegram_topic_id }}"
          text: |
            üîî Frontend
            ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã
          parse_mode: 'markdown'
