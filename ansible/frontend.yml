---
- hosts: all
  vars:
    frontend_dir: /var/www/frontend

  tasks:
    - name: Start deployment
      block:
        - name: Ensure front folder exists
          file:
            path: "{{ frontend_dir }}"
            state: directory
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: '0755'
          become: yes

        - name: Upload .env.production file
          copy:
            src: ./.env.production
            dest: "{{ frontend_dir }}/.env.production"
            mode: "0644"

        - name: Pull latest code and switch to main branch
          git:
            repo: "https://github.com/Calidris-Energet/frontend.git"
            dest: "{{ frontend_dir }}"
            update: yes
            version: main
            force: yes
          become: yes

        - name: Install npm dependencies
          community.general.yarn:
            path: "{{ frontend_dir }}"
            state: present

        - name: Run the build script
          ansible.builtin.command:
            cmd: yarn build
            chdir: "{{ frontend_dir }}"

        - name: Check site accessibility
          uri:
            url: "https://energet.shop/"
            return_content: yes
            status_code: 200
          register: site_check
          ignore_errors: yes

        - name: Send notification to a specific Telegram topic
          community.general.telegram:
            token: "{{ telegram_bot_token }}"
            api_method: 'sendMessage'
            api_args:
              chat_id: "{{ telegram_chat_id }}"
              message_thread_id: "{{ telegram_topic_id }}"
              text: |
                üîî Frontend
                ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã
                
                üîó –°—Å—ã–ª–∫–∞ üîó
                https://energet.shop/
              parse_mode: 'markdown'

      rescue:
        - name: Send failure notification to Telegram
          community.general.telegram:
            token: "{{ telegram_bot_token }}"
            api_method: 'sendMessage'
            api_args:
              chat_id: "{{ telegram_chat_id }}"
              message_thread_id: "{{ telegram_topic_id }}"
              text: |
                üîî Frontend
                ‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ*
                *–°–µ—Ä–≤–µ—Ä:* {{ inventory_hostname }}
                *–í—Ä–µ–º—è:* {{ ansible_date_time.time }}
                *–ó–∞–¥–∞—á–∞:* {{ ansible_failed_task.name }}
                
                `–û—à–∏–±–∫–∞: {{ ansible_failed_result.msg | default('Unknown error') }}`
              parse_mode: 'markdown'
              disable_notification: false
